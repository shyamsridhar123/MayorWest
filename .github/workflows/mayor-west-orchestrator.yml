name: Mayor West Orchestrator

on:
  workflow_dispatch:
  pull_request:
    types: [closed]
    paths: []
  schedule:
    - cron: '*/15 * * * *'

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Find Next Unassigned mayor-task
        id: find_task
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'mayor-task',
              state: 'open',
              assignee: 'none',
              sort: 'created',
              direction: 'asc',
              per_page: 1
            });
            
            if (issues.length === 0) {
              console.log('No unassigned mayor-tasks found');
              return { found: false };
            }
            
            const task = issues[0];
            console.log(`Found task: #${task.number} - ${task.title}`);
            
            core.setOutput('task_number', task.number);
            core.setOutput('found', 'true');

      - name: Assign to Copilot
        if: steps.find_task.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const taskNumber = ${{ steps.find_task.outputs.task_number }};
            
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: taskNumber,
                assignees: ['copilot']
              });
              console.log(`Assigned issue #${taskNumber} to @copilot`);
            } catch (error) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: taskNumber,
                assignees: ['copilot[bot]']
              });
              console.log(`Assigned issue #${taskNumber} to @copilot[bot]`);
            }

      - name: Add Comment - Task Started
        if: steps.find_task.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const taskNumber = ${{ steps.find_task.outputs.task_number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: taskNumber,
              body: 'ðŸ¤– **Mayor West Mode Activated** ðŸ¤–\n\nCopilot is now executing this task. Stand by for autonomous implementation...'
            });
