name: Mayor West Auto-Approve Pending Runs
# This workflow automatically reruns workflows that are stuck in "action_required"
# This is needed because GitHub requires approval for first-time contributors

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  approve-pending:
    runs-on: ubuntu-latest
    steps:
      - name: Rerun Pending Workflows
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get all workflow runs that are action_required
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'action_required',
              per_page: 10
            });
            
            console.log(`Found ${runs.workflow_runs.length} pending workflow runs`);
            
            for (const run of runs.workflow_runs) {
              // Only rerun Mayor West workflows from Copilot
              if (run.name.includes('Mayor West') && 
                  (run.actor.login === 'Copilot' || run.actor.login === 'copilot-swe-agent')) {
                console.log(`Rerunning: ${run.name} #${run.id} (actor: ${run.actor.login})`);
                
                try {
                  await github.rest.actions.reRunWorkflow({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });
                  console.log(`✅ Rerun requested for #${run.id}`);
                } catch (error) {
                  console.log(`⚠️ Failed to rerun #${run.id}: ${error.message}`);
                }
              }
            }
            
            console.log('Done processing pending runs');
